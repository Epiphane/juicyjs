"use strict";!function(t,i){"undefined"!=typeof module&&module.exports?module.exports=i():"function"==typeof define&&define.amd?define([],i):t.Juicy=i(t)}(this,function(t){t=t||{},t.requestAnimFrame=function(){return t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||function(i){t.setTimeout(i,1e3/60)}}();var i={};i.rand=function(t,i){return i?Math.floor(Math.random()*(i-t))+t:Math.floor(Math.random()*t)},i.PI=3.1415926535;var e=i.Game=function(t,i,e){return this.running=!1,this.width=i,this.height=e,this.setCanvas(t),this.loading=!1,this.waitingForLoad=!1,this.mouse={x:0,y:0},this.DEBUG=!1,this};e.prototype.setDebug=function(t){this.DEBUG=t,t&&(this._fps=[],this._fpsLogged=0)},e.prototype.preload=function(t,e){t=t||[],e=e||[];var n=this,s=t.length+e.length,o=0,h=function(){o++,o===s?(n.loading=!1,n.waitingForLoad&&(n.waitingForLoad=!1,n.run())):n.onprogress(o/s)};if(!this.onprogress){var r=this.canvas.width/s;this.onprogress=function(t){var e=this.canvas.getContext("2d");e.fillStyle="rgb("+i.rand(255)+", "+i.rand(255)+", "+i.rand(255)+")",e.fillRect(this.canvas.width*t-r,0,r,this.canvas.height)}}this.loading=!0;for(var a=0;a<t.length;a++){var c=new Image;c.src=t[a],c.onload=h}for(var a=0;a<e.length;a++){var p=new Audio;p.src=e[a],p.oncanplaythrough=h}},e.prototype.setInput=function(t){this.input=t;return this},e.prototype.getCanvasCoords=function(t){var i=this.canvas.getBoundingClientRect(),e=(t.x||t.clientX)-i.left,n=(t.y||t.clientY)-i.top;return{x:Math.floor(e*this.width/this.canvas.width),y:Math.floor(n*this.height/this.canvas.height)}},e.prototype.setCanvas=function(t){this.canvas=t,this.context=t.getContext("2d");var i=this,e=!1;return t.onmousedown=function(t){e=t,i.trigger("dragstart",t)},t.onmouseup=function(t){var n=i.getCanvasCoords(e),s=i.getCanvasCoords(t),o=n.x-s.x,h=n.y-s.y,r=Math.sqrt(o*o+h*h);2>=r?i.trigger("click",t):i.trigger("dragend",t),e=!1},t.onmousemove=function(t){var n=i.getCanvasCoords(t);i.mouse.x=n.x,i.mouse.y=n.y,e&&i.trigger("drag",t)},this.resize()},e.prototype.resize=function(){var t=this.canvas.parentElement,i=t.width||t.clientWidth,e=t.height||t.clientHeight;return this.canvas.width=i,this.canvas.height=i*this.height/this.width,this.canvas.height>e&&(this.canvas.height=e,this.canvas.width=e*this.width/this.height),this.scale={x:this.canvas.width/this.width,y:this.canvas.height/this.height},this.state&&(this.state.__hasRendered=!1),this},e.prototype.setState=function(t){return this.input&&this.input.clear(),this.state=t,this.state.game=this,this.state.init(),this.state.__hasRendered=!1,this},e.prototype.trigger=function(t,i){i=this.getCanvasCoords(i),this.state&&this.state[t]&&this.state[t](i.x,i.y)},e.prototype.update=function(){if(this.running){var t=this;window.requestAnimFrame(function(){t.update()});var i=(new Date).getTime(),e=!1,n=(i-this.lastTime)/1e3;if(n>.2)return void(this.lastTime=i);if(this.DEBUG){30===this._fps.length&&this._fps.splice(0,1),this._fps.push(n);for(var s=0,o=0;o<this._fps.length;o++)s+=this._fps[o];this.fps=this._fps.length/s,this.fps<50&&this._fpsLogged--<=0?(this._fpsLogged=100,console.warn("Possible bottleneck: FPS down to ",this.fps,"(",1/this.fps," sec per frame)")):this._fpsLogged--<=0&&(this._fpsLogged=500,console.log("FPS: ",this.fps))}try{this.state&&(e=!this.state.update(n,this.input)||this.state.updated,this.state.updated=!1),this.lastTime=i,(e||!this.state.__hasRendered)&&(this.render(),this.state.__hasRendered=!0)}catch(h){console.error(h),this.running=!1}}},e.prototype.render=function(){if(this.state){this.context.save(),this.context.scale(this.scale.x,this.scale.y),this.state.stopClear||this.context.clearRect(0,0,this.width,this.height);try{this.state.render(this.context)}catch(t){console.error(t.stack),this.running=!1}this.context.restore()}else this.running=!1;return this},e.prototype.run=function(){return this.loading?void(this.waitingForLoad=!0):(this.running=!0,this.lastTime=(new Date).getTime(),this.update(),this)},e.prototype.pause=function(){this.running=!1};var n=i.State=function(){this.entities=[]};i.Scene=i.Screen=i.State,n.prototype.init=function(){},n.prototype.click=function(){},n.prototype.onKey={},n.prototype.update=function(){},n.prototype.render=function(){};var s=0,o=i.Entity=function(t,e){this.components={},this.updated={},this.state=t;var e=e||this.__proto__.components;e.indexOf("Transform")>=0&&e.splice(e.indexOf("Transform"),1),this.transform=new i.Components.Transform(this);for(var n=0;n<e.length;n++)this.addComponent(e[n]);this.init()};o.prototype.init=function(){},o.prototype.components=[],o.prototype.addComponent=function(t,e){if("function"==typeof t)t=new t(this);else if("string"==typeof t){if(!i.Components[t])throw"Component "+t+" does not exist";t=new i.Components[t](this)}t.__proto__.name||(t.__proto__.name="_component_"+s.toString(),s++);var e=e||t.__proto__.name;if(this.components[e])throw"Component "+e+" already exists";t.entity=this,this.components[e]=t},o.prototype.getComponent=function(t){return this.components[t]?this.components[t]:null},o.prototype.update=function(t,i){if(i)this.updated[i]=1,this.components[i].update(t,this.state.game.input),this.updated[i]=2;else{this.dt=t,this.updated={};for(var e in this.components)this.updated[e]||this.update(t,e);delete this.dt}},o.prototype.render=function(t){t.save();var i=this.transform.position;t.translate(i.x,i.y),t.scale(this.transform.scale.x,this.transform.scale.y);var e=Array.prototype.slice.call(arguments);1===e.length&&(e.push(0),e.push(0),e.push(this.transform.width),e.push(this.transform.height));for(var n in this.components)this.components[n].render.apply(this.components[n],e);if(this.transform.children.length>0)for(var s=0;s<this.transform.children.length;s++)this.transform.children[s].render(t);t.restore()};var h=i.Component=function(){};h.prototype.name=null,h.prototype.update=function(){},h.prototype.render=function(){},i.Components={},h.create=function(t,e,n){return e.name=e.name||t,i.Components[t]&&console.warn("Overriding component",t),i.Components[t]=this.extend(e,n)};var r=i.Input=function(t,i,e){this.KEYS=i,this.CONTROLS=e,this.keyState={},this.keyCallbacks={},this.eventListeners={},this.CODES={};for(var n in i)this.CODES[i[n]]=n;return this.init(t),this};r.prototype.clear=function(){this.keyCallbacks={};for(var t in this.eventListeners)for(var i=this.eventListeners[t];i.length>0;)this.document.removeEventListener(t,i.shift());this.eventListeners={}},r.prototype.setKeys=function(t){return this.KEYS=t,this},r.prototype.setControls=function(t){return this.CONTROLS=t,this},r.prototype.keyDown=function(t){if("string"==typeof t)return this.keyState[this.KEYS[t]];for(var i=0;i<t.length;i++)if(this.keyDown(t[i]))return!0;return!1},r.prototype.init=function(t){this.document=t,this.onkey=[];var i=this;return t.onkeydown=function(t){i.keyState[t.keyCode]=!0},t.onkeyup=function(t){i.keyState[t.keyCode]=!1;var e=i.keyCallbacks[t.keyCode];for(var n in e)e[n](i.CODES[t.keyCode])},this},r.prototype.on=function(t,i,e){if("key"===t){"object"!=typeof i&&(i=[i]);for(var n=0;n<i.length;n++){var s=i[n];console.log("callback for",s,this.KEYS[s]),this.keyCallbacks[this.KEYS[s]]=this.keyCallbacks[this.KEYS[s]]||[],this.keyCallbacks[this.KEYS[s]].push(e)}}else this.document.addEventListener(t,i),this.eventListeners[t]=this.eventListeners[t]||[],this.eventListeners[t].push(i);return this};var a=function(t){var i=arguments.length;if(2>i||null==t)return t;for(var e=1;i>e;e++){var n=arguments[e];for(var s in n)t[s]=n[s]}return t},c=function(t,i){var e,n=this;t=t||{},i=i||{},e=Object.keys(t).indexOf("constructor")>=0?t.constructor:function(){return n.apply(this,arguments)},a(e,n,i);var s=function(){this.constructor=e};return s.prototype=n.prototype,e.prototype=new s,t&&a(e.prototype,t),e.prototype.__super__=n.prototype,e};e.extend=n.extend=o.extend=h.extend=c,r.extend=c,h.create("Image",{constructor:function(t){var i=this;this._tint=!1,this.opacity=1,this.image=new Image,this.image.onload=function(){t.transform.width||t.transform.height||(t.transform.width=this.width,t.transform.height=this.height),t.state.updated=!0,i._tint&&i.setTint(i._tint),i.onload&&i.onload(this)},t.setImage=this.setImage.bind(this)},setTint:function(t){if(this._tint=t,this.image.complete){this.overlay||(this.overlay=document.createElement("canvas")),this.overlay.width=this.image.width,this.overlay.height=this.image.height;var i=this.overlay.getContext("2d");i.fillStyle=this._tint,i.fillRect(0,0,this.overlay.width,this.overlay.height),i.globalCompositeOperation="destination-atop",i.globalAlpha=.75,i.drawImage(this.image,0,0),i.globalAlpha=1}},setImage:function(t,i){return this.image.src=t,this.tint=i||this.tint,this},render:function(t){var i=t.globalAlpha;t.globalAlpha=this.opacity,arguments[0]=this.image,t.drawImage.apply(t,arguments),this._tint&&(arguments[0]=this.overlay,t.drawImage.apply(t,arguments)),t.globalAlpha=i}}),h.create("Box",{constructor:function(){this.fillStyle="white"},render:function(t,i,e,n,s){t.fillStyle=this.fillStyle,t.fillRect(i,e,n,s)}}),h.create("Text",{constructor:function(){this.text=new i.Text},set:function(t){this.text.set(t),this.entity.transform.width=this.text.canvas.width,this.entity.transform.height=this.text.canvas.height},align:function(t){this.text.align(t)},render:function(t){this.text.render(t,0,0)}}),h.create("Transform",{constructor:function(t){this.position={x:0,y:0},this.scale={x:1,y:1},this.width=this.height=0,this.children=[],this.entity=t},contains:function(t,i){var e=this.getPosition(),n=this.getScale();return t>=e.x&&i>=e.y&&t<=e.x+this.width*n.x&&i<=e.y+this.height*n.y?!0:!1},distance:function(t){var i=t.position.x+t.width/2-(this.position.x+this.width/2),e=t.position.y+t.height/2-(this.position.y+this.height/2);return Math.sqrt(i*i+e*e)},collides:function(t){var i=t.position.x>=this.position.x+this.width,e=t.position.x+t.width<=this.position.x,n=t.position.y>=this.position.y+this.height,s=t.position.y+t.height<=this.position.y;return!(i||e||n||s)},getPosition:function(){if(this.parent){var t=this.parent.getPosition(),i=this.parent.getScale();return{x:t.x+this.position.x*i.x,y:t.y+this.position.y*i.y}}return this.position},getScale:function(){if(this.parent){var t=this.parent.getScale();return{x:t.x*this.scale.x,y:t.y*this.scale.y}}return this.scale},addChild:function(t){t.parent=this.entity,t.transform.parent=this,this.children.push(t)}});var p=i.Text=function(t,i,e,n){return this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),i=i||"32px Arial",t=t||"",e=e||"white",this.align(n||"left"),this.opacity=1,this.set({text:t,font:i,fillStyle:e})};return p.prototype.set=function(t){return t.text&&(this.text=t.text),t.font&&(this.font=t.font),t.fillStyle&&(this.fillStyle=t.fillStyle),this.draw()},p.prototype.align=function(t){this.alignment=t,["left","center","right"].indexOf(t)<0&&console.warn(t,"is not a valid alignment")},p.prototype.draw=function(){this.context.font=this.font,this.context.fillStyle=this.fillStyle;var t=this.context.measureText(this.text);return t.height=parseInt(this.font,10),this.canvas.width=Math.ceil(t.width),this.canvas.height=Math.ceil(5*t.height/3),this.context.textBaseline="top",this.context.font=this.font,this.context.fillStyle=this.fillStyle,this.context.fillText(this.text,0,0),this.entity&&this.entity.state&&(this.entity.state.updated=!0),this},p.prototype.render=function(t,i,e,n,s,o){if(arguments[0]=this.canvas,"left"!==this.alignment){var o=arguments.length<9?1:5;"center"===this.alignment?arguments[o]-=this.canvas.width/2:"right"===this.alignment&&(arguments[o]-=this.canvas.width)}var h=t.globalAlpha;t.globalAlpha=this.opacity,t.drawImage.apply(t,arguments),t.globalAlpha=h},i});