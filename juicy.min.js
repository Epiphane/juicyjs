"use strict";!function(t,e){var n=function(){return t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||function(e){t.setTimeout(e,1e3/60)}}(),i=t.Juicy={},o=i.Point=function(t,e){this.x=t=t||0,this.y=e||t};o.prototype.add=function(t){return new o(this.x+t.x,this.y+t.y)},o.prototype.mult=function(t){return new o(this.x*(t.x||t),this.y*(t.y||t))},o.prototype.sub=function(t){return this.add(t.mult(-1))},o.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};var r=(new(t.AudioContext||t.webkitAudioContext),{}),s=i.Sound=function(t,e,n){"string"!=typeof e&&(e=t,n=e),this.name=e,this.options=n||{},r[t]||s.load(t,e)};s.load=function(t,n){var i=r[t]=e.createElement("audio"),o=e.createElement("source");o.src=n,i.appendChild(o),i.load()},s.play=s.prototype.play=function(t){t=this.name||t,r[t].play()},s.pause=s.prototype.pause=function(t){t=this.name||t,r[t].pause()};var a=i.Game={},h=new o(1),p=new o,u=!1,c=!1,l=!1,d=!1,f=!1,g={},y={},m={},v={};e.onkeydown=function(t){g[t.keyCode]=!0},e.onkeyup=function(t){g[t.keyCode]=!1;var e="key_"+m[t.keyCode];c&&c[e]&&c[e](m[t.keyCode])},a.init=function(t,e,n,i){u=!1,a.width=e,a.height=n,a.setCanvas(t),y=i||{},m={};for(var o in i)m[i[o]]=o;return this},a.keyDown=function(t){if("string"==typeof t)return g[y[t]];for(var e=0;e<t.length;e++)if(a.keyDown(t[e]))return!0;return!1},a.on=function(t,n,i){if("key"===t){"object"!=typeof n&&(n=[n]);for(var o=0;o<n.length;o++){var r=n[o];c["key_"+r]=i}}else v[t]&&e.removeEventListener(t,v[t]),e.addEventListener(t,v[t]=n);return this};var w=function(){for(var t in v)e.removeEventListener(t,v[t]);v={}};a.getCanvasCoords=function(t){var e=l.getBoundingClientRect(),n=t.clientX-e.left,i=t.clientY-e.top;return new o(Math.floor(n*a.width/l.width),Math.floor(i*a.height/l.height))},a.setCanvas=function(t){l=t,d=t.getContext("2d");var e=!1;return t.onmousedown=function(t){e=t,a.trigger("dragstart",t)},t.onmouseup=function(t){var n=a.getCanvasCoords(e),i=a.getCanvasCoords(t);n.sub(i).length()<=2?a.trigger("click",t):a.trigger("dragend",t),e=!1},t.onmousemove=function(t){p=a.getCanvasCoords(t),e&&a.trigger("drag",t)},a.resize(),this},a.resize=function(){var t=l.parentElement,e=t.width||t.clientWidth,n=t.height||t.clientHeight;return l.width=e,l.height=e*a.height/a.width,l.height>n&&(l.height=n,l.width=n*a.width/a.height),h=new o(l.width/a.width,l.height/a.height),c&&(c.__hasRendered=!1),this},a.setState=function(t){return w(),c=t,c.game=a,c.init(),c.__hasRendered=!1,this},a.trigger=function(t,e){c&&c[t]&&c[t](a.getCanvasCoords(e))},a.update=function(){if(u){n(a.update);var t=(new Date).getTime(),e=(t-f)/1e3;if(e>.2)return void(f=t);try{var i=!c.update(e,a)||c.updated;c.updated=!1,f=t,(i||!c.__hasRendered)&&(a.render(),c.__hasRendered=!0)}catch(o){console.error(o),a.pause()}}},a.render=function(){return d.save(),d.scale(h.x,h.y),c.stopClear||d.clearRect(0,0,a.width,a.height),c.render(d),d.restore(),this},a.run=function(){return u=!0,f=(new Date).getTime(),a.update(),this},a.pause=function(){u=!1};var x=i.State=function(){};x.prototype.init=x.prototype.update=x.prototype.render=function(){};var _=0,C=i.Entity=function(t,e){"string"==typeof e&&(e=[e]),this.components={},this.updated={},this.state=t,this.children=[],e=e||this.__proto__.components,this.position=new o,this.scale=new o(1),this.width=this.height=0;for(var n=0;n<e.length;n++)this.addComponent(e[n]);this.init&&this.init()};C.prototype.components=[],C.prototype.addComponent=function(t,e){if("function"==typeof t)t=new t(this);else if("string"==typeof t){if(!i.Components[t])throw"Component "+t+" does not exist";t=new i.Components[t](this)}t.__proto__.name||(t.__proto__.name="_component_"+_.toString(),_++);var e=e||t.__proto__.name;if(this.components[e])throw"Component "+e+" already exists";t.entity=this,this.components[e]=t},C.prototype.getComponent=function(t){return this.components[t]},C.prototype.update=function(t,e){if(e&&!this.updated[e])return this.updated[e]=!0,this.components[e].update(t,this.state.game),this.components[e];this.updated={};for(var n in this.components)this.updated[n]||this.update(t,n)},C.prototype.render=function(t){t.save();var e=this.position;t.translate(e.x,e.y),t.scale(this.scale.x,this.scale.y);var n=Array.prototype.slice.call(arguments);1===n.length&&(n.push(0),n.push(0),n.push(this.width),n.push(this.height));for(var i in this.components)this.components[i].render.apply(this.components[i],n);if(this.children.length>0)for(var o=0;o<this.children.length;o++)this.children[o].render(t);t.restore()},C.prototype.addChild=function(t){t.parent=this,this.children.push(t)},C.prototype.globalPosition=function(){var t,e=this.position;return(t=this.parent)?t.globalPosition().add(this.position.mult(t.globalScale())):e},C.prototype.globalScale=function(){var t=this.scale;return this.parent?this.scale.mult(this.parent.globalScale()):t};var b=i.Component=function(){};b.prototype.name=0,b.prototype.update=b.prototype.render=function(){},i.Components={},b.create=function(t,e,n){return e.name=e.name||t,i.Components[t]=this.extend(e,n)};var S=function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)t[i]=n[i]}},A=function(t,e){var n,i=this;n=t.constructor!==t.__proto__.constructor?t.constructor:function(){return i.apply(this,arguments)},S(n,i,e||{});var o=function(){this.constructor=n};return o.prototype=i.prototype,n.prototype=new o,t&&S(n.prototype,t),n.prototype.__super__=i.prototype,n};x.extend=C.extend=b.extend=A,b.create("Image",{constructor:function(t){var e=this;this._tint=!1,this.opacity=1,this.image=new Image,this.image.onload=function(){t.width||t.height||(t.width=this.width,t.height=this.height),e._tint&&e.setTint(e._tint),e.onload&&e.onload(this),t.state.updated=!0},this.image.onerror=function(){e.image=new Image},t.setImage=this.setImage.bind(this)},setTint:function(t){if(this._tint=t,this.image.complete){var n=this.canvas=this.canvas||e.createElement("canvas");n.width=this.image.width,n.height=this.image.height;var i=n.getContext("2d");i.fillStyle=this._tint,i.fillRect(0,0,n.width,n.height),i.globalCompositeOperation="destination-atop",i.globalAlpha=.75,i.drawImage(this.image,0,0),i.globalAlpha=1}return this},setImage:function(t){return this.image.src=t,this},render:function(t){var e=t.globalAlpha,n=arguments;t.globalAlpha=this.opacity,n[0]=this.image,t.drawImage.apply(t,n),this._tint&&(n[0]=this.canvas,t.drawImage.apply(t,n)),t.globalAlpha=e}}),b.create("Box",{constructor:function(){this.fillStyle="white"},render:function(t,e,n,i,o){t.fillStyle=this.fillStyle,t.fillRect(e,n,i,o)}}),b.create("Text",{constructor:function(){this.canvas=e.createElement("canvas"),this.context=this.canvas.getContext("2d");var t=this.text={};t.font="32px Arial",t.text="",t.fillStyle="white",this.opacity=1},set:function(t){var e=this.text,n=this.entity,i=this.context,o=this.canvas;e.font=t.font||e.font,e.text=t.text||e.text,e.fillStyle=t.fillStyle||e.fillStyle,i.font=e.font,i.fillStyle=e.fillStyle;var r=i.measureText(e.text);n.width=o.width=Math.ceil(r.width),n.height=o.height=Math.ceil(5*parseInt(e.font)/3),i.textBaseline="top",i.font=e.font,i.fillStyle=e.fillStyle,i.fillText(e.text,0,0)},render:function(t){var e=t.globalAlpha;t.globalAlpha=this.opacity,arguments[0]=this.canvas,t.drawImage.apply(t,arguments),t.globalAlpha=e}}),i.rand=function(t,e){return e?Math.floor(Math.random()*(e-t))+t:Math.floor(Math.random()*t)},i.PI=Math.PI,C.prototype.contains=function(t){return t=t.sub(this.position),t.x>=0&&t.y>=0&&t.x<=this.width&&t.y<=this.height},C.prototype.distance=function(t){return t.x||(t=t.position),this.position.sub(t).length()},C.prototype.testCollision=function(t){var e=t.position.add(new o(t.width,t.height)),n=this.position.add(new o(this.width,this.height));return e.x>=this.position.x&&e.y>=this.position.y&&t.position.x<=n.x&&t.position.y<=n.y}}(window,document);