"use strict";!function(t,e){"undefined"!=typeof module&&module.exports?module.exports=e():"function"==typeof define&&define.amd?define([],e):t.Juicy=e(t)}(this,function(t){t=t||{},t.requestAnimFrame=function(){return t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||function(e){t.setTimeout(e,1e3/60)}}();var e={};e.rand=function(t,e){return e?Math.floor(Math.random()*(e-t))+t:Math.floor(Math.random()*t)},e.PI=3.1415926535;var i=e.Game=function(t,e,i){return this.running=!1,this.width=e,this.height=i,this.setCanvas(t),this.mouse={x:0,y:0},this};i.prototype.setInput=function(t){this.input=t;return this},i.prototype.getCanvasCoords=function(t){var e=this.canvas.getBoundingClientRect(),i=(t.x||t.clientX)-e.left,n=(t.y||t.clientY)-e.top;return{x:Math.floor(i*this.width/this.canvas.width),y:Math.floor(n*this.height/this.canvas.height)}},i.prototype.setCanvas=function(t){this.canvas=t,this.context=t.getContext("2d");var e=this;return t.onclick=function(t){t=e.getCanvasCoords(t),e.click(t.x,t.y)},t.onmousemove=function(t){t=e.getCanvasCoords(t),e.mouse.x=t.x,e.mouse.y=t.y},this.resize()},i.prototype.resize=function(){var t=this.canvas.parentElement,e=t.width||t.clientWidth,i=t.height||t.clientHeight;return this.canvas.width=e,this.canvas.height=e*this.height/this.width,this.canvas.height>i&&(this.canvas.height=i,this.canvas.width=i*this.width/this.height),this.scale={x:this.canvas.width/this.width,y:this.canvas.height/this.height},this.state&&(this.state.__hasRendered=!1),this},i.prototype.setState=function(t){return this.input.clear(),this.state=t,this.state.game=this,this.state.init(),this.state.__hasRendered=!1,this},i.prototype.click=function(t,e){this.state&&this.state.click(t,e)},i.prototype.update=function(){if(this.running){var e=this;t.requestAnimFrame(function(){e.update()});var i=(new Date).getTime(),n=!1,s=(i-this.lastTime)/1e3;if(s>.2)return void(this.lastTime=i);try{this.state&&(n=!this.state.update(s,this.input)||this.state.updated,this.state.updated=!1),this.lastTime=i,(n||!this.state.__hasRendered)&&(this.render(),this.state.__hasRendered=!0)}catch(o){console.error(o),this.running=!1}}},i.prototype.render=function(){if(this.state){this.context.save(),this.context.scale(this.scale.x,this.scale.y),this.state.stopClear||this.context.clearRect(0,0,this.width,this.height);try{this.state.render(this.context)}catch(t){console.error(t.stack),this.running=!1}this.context.restore()}else this.running=!1;return this},i.prototype.run=function(){return this.running=!0,this.lastTime=(new Date).getTime(),this.update(),this},i.prototype.pause=function(){this.running=!1};var n=e.State=function(){this.entities=[]};e.Scene=e.Screen=e.State,n.prototype.init=function(){},n.prototype.click=function(){},n.prototype.onKey={},n.prototype.update=function(){},n.prototype.render=function(){};var s=0,o=e.Entity=function(t,i){this.components={},this.updated={},this.state=t;var i=i||this.__proto__.components;i.indexOf("Transform")>=0&&i.splice(i.indexOf("Transform"),1),this.transform=new e.Components.Transform(this);for(var n=0;n<i.length;n++)this.addComponent(i[n]);this.init()};o.prototype.init=function(){},o.prototype.components=[],o.prototype.addComponent=function(t,i){if("function"==typeof t)t=new t(this);else if("string"==typeof t){if(!e.Components[t])throw"Component "+t+" does not exist";t=new e.Components[t](this)}t.__proto__.name||(t.__proto__.name="_component_"+s.toString(),s++);var i=i||t.__proto__.name;if(this.components[i])throw"Component "+i+" already exists";t.entity=this,this.components[i]=t},o.prototype.getComponent=function(t){if(!this.components[t])return null;if(this.dt){if(1===this.updated[t])throw"Circular component dependency: "+t+"<>";this.updated[t]||this.update(this.dt,t)}return this.components[t]},o.prototype.update=function(t,e){if(e)this.updated[e]=1,this.components[e].update(t,this.state.game.input),this.updated[e]=2;else{this.dt=t,this.updated={};for(var i in this.components)this.updated[i]||this.update(t,i);delete this.dt}},o.prototype.render=function(t){t.save();var e=this.transform.position;t.translate(e.x,e.y),t.scale(this.transform.scale.x,this.transform.scale.y);var i=Array.prototype.slice.call(arguments);1===i.length&&(i.push(0),i.push(0),i.push(this.transform.width),i.push(this.transform.height));for(var n in this.components)this.components[n].render.apply(this.components[n],i);if(this.transform.children.length>0)for(var s=0;s<this.transform.children.length;s++)this.transform.children[s].render(t);t.restore()};var h=e.Component=function(){};h.prototype.name=null,h.prototype.update=function(){},h.prototype.render=function(){},e.Components={},h.create=function(t,i,n){return i.name=i.name||t,e.Components[t]&&console.warn("Overriding component",t),e.Components[t]=h.extend(i,n)};var r=e.Input=function(t,e,i){this.KEYS=e,this.CONTROLS=i,this.keyState={},this.keyCallbacks={},this.eventListeners={},this.CODES={};for(var n in e)this.CODES[e[n]]=n;return this.init(t),this};r.prototype.clear=function(){this.keyCallbacks={};for(var t in this.eventListeners)for(var e=this.eventListeners[t];e.length>0;)this.document.removeEventListener(t,e.shift());this.eventListeners={}},r.prototype.setKeys=function(t){return this.KEYS=t,this},r.prototype.setControls=function(t){return this.CONTROLS=t,this},r.prototype.keyDown=function(t){if("string"==typeof t)return this.keyState[this.KEYS[t]];for(var e=0;e<t.length;e++)if(this.keyDown(t[e]))return!0;return!1},r.prototype.init=function(t){this.document=t,this.onkey=[];var e=this;return t.onkeydown=function(t){e.keyState[t.keyCode]=!0},t.onkeyup=function(t){e.keyState[t.keyCode]=!1;var i=e.keyCallbacks[t.keyCode];for(var n in i)i[n](e.CODES[t.keyCode])},this},r.prototype.on=function(t,e,i){if("key"===t){"object"!=typeof e&&(e=[e]);for(var n=0;n<e.length;n++){var s=e[n];console.log("callback for",s,this.KEYS[s]),this.keyCallbacks[this.KEYS[s]]=this.keyCallbacks[this.KEYS[s]]||[],this.keyCallbacks[this.KEYS[s]].push(i)}}else this.document.addEventListener(t,e),this.eventListeners[t]=this.eventListeners[t]||[],this.eventListeners[t].push(e);return this};var a=function(t){var e=arguments.length;if(2>e||null==t)return t;for(var i=1;e>i;i++){var n=arguments[i];for(var s in n)t[s]=n[s]}return t},c=function(t,e){var i,n=this;t=t||{},e=e||{},i=Object.keys(t).indexOf("constructor")>=0?t.constructor:function(){return n.apply(this,arguments)},a(i,n,e);var s=function(){this.constructor=i};return s.prototype=n.prototype,i.prototype=new s,t&&a(i.prototype,t),i.__super__=n.prototype,i};i.extend=n.extend=o.extend=h.extend=c,r.extend=c,h.create("Image",{constructor:function(t){var e=this;this._tint=!1,this.opacity=1,this.image=new Image,this.image.onload=function(){t.transform.width||t.transform.height||(t.transform.width=this.width,t.transform.height=this.height),t.state.updated=!0,e._tint&&e.setTint(e._tint),e.onload&&e.onload(this)},t.setImage=this.setImage.bind(this)},setTint:function(t){if(this._tint=t,this.image.complete){this.overlay||(this.overlay=document.createElement("canvas")),this.overlay.width=this.image.width,this.overlay.height=this.image.height;var e=this.overlay.getContext("2d");e.fillStyle=this._tint,e.fillRect(0,0,this.overlay.width,this.overlay.height),e.globalCompositeOperation="destination-atop",e.globalAlpha=.75,e.drawImage(this.image,0,0),e.globalAlpha=1}},setImage:function(t,e){return this.image.src=t,this.tint=e||this.tint,this},render:function(t){var e=t.globalAlpha;t.globalAlpha=this.opacity,arguments[0]=this.image,t.drawImage.apply(t,arguments),this._tint&&(arguments[0]=this.overlay,t.drawImage.apply(t,arguments)),t.globalAlpha=e}}),h.create("Box",{constructor:function(){this.fillStyle="white"},render:function(t,e,i,n,s){t.fillStyle=this.fillStyle,t.fillRect(e,i,n,s)}}),h.create("Transform",{constructor:function(t){this.position={x:0,y:0},this.scale={x:1,y:1},this.width=this.height=0,this.children=[],this.entity=t},contains:function(t,e){var i=this.getPosition(),n=this.getScale();return t>=i.x&&e>=i.y&&t<=i.x+this.width*n.x&&e<=i.y+this.height*n.y?!0:!1},distance:function(t){var e=t.position.x+t.width/2-(this.position.x+this.width/2),i=t.position.y+t.height/2-(this.position.y+this.height/2);return Math.sqrt(e*e+i*i)},collides:function(t){var e=t.position.x>=this.position.x+this.width,i=t.position.x+t.width<=this.position.x,n=t.position.y>=this.position.y+this.height,s=t.position.y+t.height<=this.position.y;return!(e||i||n||s)},getPosition:function(){if(this.parent){var t=this.parent.getPosition(),e=this.parent.getScale();return{x:t.x+this.position.x*e.x,y:t.y+this.position.y*e.y}}return this.position},getScale:function(){if(this.parent){var t=this.parent.getScale();return{x:t.x*this.scale.x,y:t.y*this.scale.y}}return this.scale},addChild:function(t){t.parent=this.entity,t.transform.parent=this,this.children.push(t)}});var p=e.Text=function(t,e,i,n){return this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),e=e||"32px Arial",t=t||"",i=i||"white",this.align(n||"left"),this.opacity=1,this.set({text:t,font:e,fillStyle:i})};return p.prototype.set=function(t){return t.text&&(this.text=t.text),t.font&&(this.font=t.font),t.fillStyle&&(this.fillStyle=t.fillStyle),this.draw()},p.prototype.align=function(t){this.alignment=t,["left","center","right"].indexOf(t)<0&&console.warn(t,"is not a valid alignment")},p.prototype.draw=function(){this.context.font=this.font,this.context.fillStyle=this.fillStyle;var t=this.context.measureText(this.text);return t.height=parseInt(this.font,10),this.canvas.width=Math.ceil(t.width),this.canvas.height=Math.ceil(5*t.height/3),this.context.textBaseline="top",this.context.font=this.font,this.context.fillStyle=this.fillStyle,this.context.fillText(this.text,0,0),this.entity&&this.entity.state&&(this.entity.state.updated=!0),this},p.prototype.render=function(t,e,i,n,s,o){if(arguments[0]=this.canvas,"left"!==this.alignment){var o=arguments.length<9?1:5;"center"===this.alignment?arguments[o]-=this.canvas.width/2:"right"===this.alignment&&(arguments[o]-=this.canvas.width)}var h=t.globalAlpha;t.globalAlpha=this.opacity,t.drawImage.apply(t,arguments),t.globalAlpha=h},e});