"use strict";!function(t){window.J=window.Juicy=t(window)}(function(t){var i="prototype";t=t||{},t.requestAnimFrame=function(){return t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||function(i){t.setTimeout(i,1e3/60)}}();var e={},n=e.Game=function(t,i,e){return this.running=!1,this.width=i,this.height=e,this.setCanvas(t),this.mouse={x:0,y:0},this};n[i].setInput=function(t){this.input=t;return this},n[i].getCanvasCoords=function(t){var i=this.canvas.getBoundingClientRect(),e=t.clientX-i.left,n=t.clientY-i.top;return{x:Math.floor(e*this.width/this.canvas.width),y:Math.floor(n*this.height/this.canvas.height)}},n[i].setCanvas=function(t){this.canvas=t,this.context=t.getContext("2d");var i=this,e=!1;return t.onmousedown=function(t){e=t,i.trigger("dragstart",t)},t.onmouseup=function(t){var n=i.getCanvasCoords(e),s=i.getCanvasCoords(t),h=n.x-s.x,a=n.y-s.y,o=Math.sqrt(h*h+a*a);2>=o?i.trigger("click",t):i.trigger("dragend",t),e=!1},t.onmousemove=function(t){var n=i.getCanvasCoords(t);i.mouse.x=n.x,i.mouse.y=n.y,e&&i.trigger("drag",t)},this.resize()},n[i].resize=function(){var t=this.canvas.parentElement,i=t.width||t.clientWidth,e=t.height||t.clientHeight;return this.canvas.width=i,this.canvas.height=i*this.height/this.width,this.canvas.height>e&&(this.canvas.height=e,this.canvas.width=e*this.width/this.height),this.scale={x:this.canvas.width/this.width,y:this.canvas.height/this.height},this.state&&(this.state.__hasRendered=!1),this},n[i].setState=function(t){return this.input&&this.input.clear(),this.state=t,this.state.game=this,this.state.init(),this.state.__hasRendered=!1,this},n[i].trigger=function(t,i){i=this.getCanvasCoords(i),this.state&&this.state[t]&&this.state[t](i.x,i.y)},n[i].update=function(){if(this.running){var i=this;t.requestAnimFrame(function(){i.update()});var e=(new Date).getTime(),n=!1,s=(e-this.lastTime)/1e3;if(s>.2)return void(this.lastTime=e);try{this.state&&(n=!this.state.update(s,this.input)||this.state.updated,this.state.updated=!1),this.lastTime=e,(n||!this.state.__hasRendered)&&(this.render(),this.state.__hasRendered=!0)}catch(h){console.error(h),this.pause()}}},n[i].render=function(){this.context.save(),this.context.scale(this.scale.x,this.scale.y),this.state.stopClear||this.context.clearRect(0,0,this.width,this.height);try{this.state.render(this.context)}catch(t){console.error(t.stack),this.pause()}return this.context.restore(),this},n[i].run=function(){return this.running=!0,this.lastTime=(new Date).getTime(),this.update(),this},n[i].pause=function(){this.running=!1};var s=e.State=function(){this.entities=[]};s[i].init=function(){},s[i].update=function(){},s[i].render=function(){};var h=0,a=e.Entity=function(t,i){this.components={},this.updated={},this.state=t,i=i||this.__proto__.components,this.transform=new e.Components.Transform(this);for(var n=0;n<i.length;n++)this.addComponent(i[n]);this.init&&this.init()};a[i].components=[],a[i].addComponent=function(t,i){if("function"==typeof t)t=new t(this);else if("string"==typeof t){if(!e.Components[t])throw"Component "+t+" does not exist";t=new e.Components[t](this)}t.__proto__.name||(t.__proto__.name="_component_"+h.toString(),h++);var i=i||t.__proto__.name;if(this.components[i])throw"Component "+i+" already exists";t.entity=this,this.components[i]=t},a[i].getComponent=function(t){return this.components[t]},a[i].update=function(t,i){if(i&&!this.updated[i])this.updated[i]=!0,this.components[i].update(t,this.state.game.input);else{this.updated={};for(var e in this.components)this.updated[e]||this.update(t,e)}},a[i].render=function(t){t.save();var e=this.transform.position;t.translate(e.x,e.y),t.scale(this.transform.scale.x,this.transform.scale.y);var n=Array[i].slice.call(arguments);1===n.length&&(n.push(0),n.push(0),n.push(this.transform.width),n.push(this.transform.height));for(var s in this.components)this.components[s].render.apply(this.components[s],n);if(this.transform.children.length>0)for(var h=0;h<this.transform.children.length;h++)this.transform.children[h].render(t);t.restore()};var o=e.Component=function(){};o[i].name=null,o[i].update=function(){},o[i].render=function(){},e.Components={},o.create=function(t,i,n){return i.name=i.name||t,e.Components[t]&&console.warn("Overriding component",t),e.Components[t]=this.extend(i,n)};var r=e.Input=function(t,i){this.KEYS=i,this.keyState={},this.keyCallbacks={},this.eventListeners={},this.CODES={};for(var e in i)this.CODES[i[e]]=e;return this.init(t),this};r[i].clear=function(){this.keyCallbacks={};for(var t in this.eventListeners)for(var i=this.eventListeners[t];i.length>0;)this.document.removeEventListener(t,i.shift());this.eventListeners={}},r[i].setKeys=function(t){return this.KEYS=t,this},r[i].keyDown=function(t){if("string"==typeof t)return this.keyState[this.KEYS[t]];for(var i=0;i<t.length;i++)if(this.keyDown(t[i]))return!0;return!1},r[i].init=function(t){this.document=t,this.onkey=[];var i=this;return t.onkeydown=function(t){i.keyState[t.keyCode]=!0},t.onkeyup=function(t){i.keyState[t.keyCode]=!1;var e=i.keyCallbacks[t.keyCode];for(var n in e)e[n](i.CODES[t.keyCode])},this},r[i].on=function(t,i,e){if("key"===t){"object"!=typeof i&&(i=[i]);for(var n=0;n<i.length;n++){var s=i[n];console.log("callback for",s,this.KEYS[s]),this.keyCallbacks[this.KEYS[s]]=this.keyCallbacks[this.KEYS[s]]||[],this.keyCallbacks[this.KEYS[s]].push(e)}}else this.document.addEventListener(t,i),this.eventListeners[t]=this.eventListeners[t]||[],this.eventListeners[t].push(i);return this};var c=function(t){var i=arguments.length;if(2>i||null==t)return t;for(var e=1;i>e;e++){var n=arguments[e];for(var s in n)t[s]=n[s]}return t},u=function(t,e){var n,s=this;t=t||{},e=e||{},n=Object.keys(t).indexOf("constructor")>=0?t.constructor:function(){return s.apply(this,arguments)},c(n,s,e);var h=function(){this.constructor=n};return h[i]=s[i],n[i]=new h,t&&c(n[i],t),n[i].__super__=s[i],n};n.extend=s.extend=a.extend=o.extend=u,r.extend=u,o.create("Image",{constructor:function(t){var i=this;this._tint=!1,this.opacity=1,this.image=new Image,this.image.onload=function(){t.transform.width||t.transform.height||(t.transform.width=this.width,t.transform.height=this.height),t.state.updated=!0,i._tint&&i.setTint(i._tint),i.onload&&i.onload(this)},t.setImage=this.setImage.bind(this)},setTint:function(t){if(this._tint=t,this.image.complete){this.overlay||(this.overlay=document.createElement("canvas")),this.overlay.width=this.image.width,this.overlay.height=this.image.height;var i=this.overlay.getContext("2d");i.fillStyle=this._tint,i.fillRect(0,0,this.overlay.width,this.overlay.height),i.globalCompositeOperation="destination-atop",i.globalAlpha=.75,i.drawImage(this.image,0,0),i.globalAlpha=1}},setImage:function(t,i){return this.image.src=t,this.tint=i||this.tint,this},render:function(t){var i=t.globalAlpha;t.globalAlpha=this.opacity,arguments[0]=this.image,t.drawImage.apply(t,arguments),this._tint&&(arguments[0]=this.overlay,t.drawImage.apply(t,arguments)),t.globalAlpha=i}}),o.create("Box",{constructor:function(){this.fillStyle="white"},render:function(t,i,e,n,s){t.fillStyle=this.fillStyle,t.fillRect(i,e,n,s)}}),o.create("Text",{constructor:function(){this.text=new e.Text},set:function(t){this.text.set(t),this.entity.transform.width=this.text.canvas.width,this.entity.transform.height=this.text.canvas.height},align:function(t){this.text.align(t)},render:function(t){this.text.render(t,0,0)}}),o.create("Transform",{constructor:function(t){this.position={x:0,y:0},this.scale={x:1,y:1},this.width=this.height=0,this.children=[],this.entity=t},contains:function(t,i){var e=this.getPosition(),n=this.getScale();return t>=e.x&&i>=e.y&&t<=e.x+this.width*n.x&&i<=e.y+this.height*n.y?!0:!1},distance:function(t){var i=t.position.x+t.width/2-(this.position.x+this.width/2),e=t.position.y+t.height/2-(this.position.y+this.height/2);return Math.sqrt(i*i+e*e)},collides:function(t){var i=t.position.x>=this.position.x+this.width,e=t.position.x+t.width<=this.position.x,n=t.position.y>=this.position.y+this.height,s=t.position.y+t.height<=this.position.y;return!(i||e||n||s)},getPosition:function(){if(this.parent){var t=this.parent.getPosition(),i=this.parent.getScale();return{x:t.x+this.position.x*i.x,y:t.y+this.position.y*i.y}}return this.position},getScale:function(){if(this.parent){var t=this.parent.getScale();return{x:t.x*this.scale.x,y:t.y*this.scale.y}}return this.scale},addChild:function(t){t.parent=this.entity,t.transform.parent=this,this.children.push(t)}});var l=e.Text=function(t,i,e,n){return this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),i=i||"32px Arial",t=t||"",e=e||"white",this.align(n||"left"),this.opacity=1,this.set({text:t,font:i,fillStyle:e})};return l[i].set=function(t){return t.text&&(this.text=t.text),t.font&&(this.font=t.font),t.fillStyle&&(this.fillStyle=t.fillStyle),this.draw()},l[i].align=function(t){this.alignment=t,["left","center","right"].indexOf(t)<0&&console.warn(t,"is not a valid alignment")},l[i].draw=function(){this.context.font=this.font,this.context.fillStyle=this.fillStyle;var t=this.context.measureText(this.text);return t.height=parseInt(this.font,10),this.canvas.width=Math.ceil(t.width),this.canvas.height=Math.ceil(5*t.height/3),this.context.textBaseline="top",this.context.font=this.font,this.context.fillStyle=this.fillStyle,this.context.fillText(this.text,0,0),this.entity&&this.entity.state&&(this.entity.state.updated=!0),this},l[i].render=function(t,i,e,n,s,h){if(arguments[0]=this.canvas,"left"!==this.alignment){var h=arguments.length<9?1:5;"center"===this.alignment?arguments[h]-=this.canvas.width/2:"right"===this.alignment&&(arguments[h]-=this.canvas.width)}var a=t.globalAlpha;t.globalAlpha=this.opacity,t.drawImage.apply(t,arguments),t.globalAlpha=a},e});