"use strict";!function(t,e){var n=function(){return e.createElement("canvas")},i="prototype",o="listener",r="width",s="height",a="canvas",c="context",u="_hR",h="fillStyle",f="font",d="text",p="opacity",m="globalAlpha",l="_tint",g="drawImage",v=function(){return t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||function(e){t.setTimeout(e,1e3/60)}}(),y=t.Juicy={},x=y.Game={},C={x:1,y:1},_={x:0,y:0},w=!1,k=!1,I=!1,T=!1,R=!1,b={},A={},E={},o={};e.onkeydown=function(t){b[t.keyCode]=!0},e.onkeyup=function(t){b[t.keyCode]=!1;var e="key_"+E[t.keyCode];k&&k[e]&&k[e](E[t.keyCode])},x.init=function(t,e,n,i){w=!1,x[r]=e,x[s]=n,x.setCanvas(t),A=i,E={};for(var o in i)E[i[o]]=o},x.keyDown=function(t){if("string"==typeof t)return b[A[t]];for(var e=0;e<t.length;e++)if(x.keyDown(t[e]))return!0;return!1},x.on=function(t,n,i){if("key"===t){"object"!=typeof n&&(n=[n]);for(var r=0;r<n.length;r++){var s=n[r];k["key_"+s]=i}}else o[t]&&e.removeEventListener(t,o[t]),e.addEventListener(t,o[t]=n)},x.clear=function(){for(var t in o)e.removeEventListener(t,o[t]);o={}},x.getCanvasCoords=function(t){var e=I.getBoundingClientRect(),n=t.clientX-e.left,i=t.clientY-e.top;return{x:Math.floor(n*x[r]/I[r]),y:Math.floor(i*x[s]/I[s])}},x.setCanvas=function(t){I=t,T=t.getContext("2d");var e=!1;t.onmousedown=function(t){e=t,x.trigger("dragstart",t)},t.onmouseup=function(t){var n=x.getCanvasCoords(e),i=x.getCanvasCoords(t),o=n.x-i.x,r=n.y-i.y,s=Math.sqrt(o*o+r*r);2>=s?x.trigger("click",t):x.trigger("dragend",t),e=!1},t.onmousemove=function(t){var n=x.getCanvasCoords(t);_.x=n.x,_.y=n.y,e&&x.trigger("drag",t)},x.resize()},x.resize=function(){var t=I.parentElement,e=t[r]||t.clientWidth,n=t[s]||t.clientHeight;I[r]=e,I[s]=e*x[s]/x[r],I[s]>n&&(I[s]=n,I[r]=n*x[r]/x[s]),C={x:I[r]/x[r],y:I[s]/x[s]},k&&(k[u]=!1)},x.setState=function(t){x.clear(),k=t,k.game=x,k.init(),k[u]=!1},x.trigger=function(t,e){e=x.getCanvasCoords(e),k&&k[t]&&k[t](e.x,e.y)},x.update=function(){if(w){v(x.update);var t=(new Date).getTime(),e=(t-R)/1e3;if(e>.2)return void(R=t);try{var n=!k.update(e,x)||k.updated;k.updated=!1,R=t,(n||!k[u])&&(x.render(),k[u]=!0)}catch(i){console.error(i),x.pause()}}},x.render=function(){T.save(),T.scale(C.x,C.y),k.stopClear||T.clearRect(0,0,x[r],x[s]),k.render(T),T.restore()},x.run=function(){w=!0,R=(new Date).getTime(),x.update()},x.pause=function(){w=!1};var M=y.State=function(){};M[i].init=function(){},M[i].update=function(){},M[i].render=function(){};var S=0,q=y.Entity=function(t,e){this.components={},this.updated={},this.state=t,this.children=[],e=e||this.__proto__.components,this.position={x:0,y:0},this.scale={x:1,y:1},this[r]=this[s]=0;for(var n=0;n<e.length;n++)this.addComponent(e[n]);this.init&&this.init()};q[i].components=[],q[i].addComponent=function(t,e){if("function"==typeof t)t=new t(this);else if("string"==typeof t){if(!y.Components[t])throw"Component "+t+" does not exist";t=new y.Components[t](this)}t.__proto__.name||(t.__proto__.name="_component_"+S.toString(),S++);var e=e||t.__proto__.name;if(this.components[e])throw"Component "+e+" already exists";t.entity=this,this.components[e]=t},q[i].getComponent=function(t){return this.components[t]},q[i].update=function(t,e){if(e&&!this.updated[e])return this.updated[e]=!0,this.components[e].update(t,this.state.game),this.components[e];this.updated={};for(var n in this.components)this.updated[n]||this.update(t,n)},q[i].render=function(t){t.save();var e=this.position;t.translate(e.x,e.y),t.scale(this.scale.x,this.scale.y);var n=Array[i].slice.call(arguments);1===n.length&&(n.push(0),n.push(0),n.push(this[r]),n.push(this[s]));for(var o in this.components)this.components[o].render.apply(this.components[o],n);if(this.children.length>0)for(var a=0;a<this.children.length;a++)this.children[a].render(t);t.restore()},q[i].addChild=function(t){t.parent=this,this.children.push(t)};var D=y.Component=function(){};D[i].name=null,D[i].update=function(){},D[i].render=function(){},y.Components={},D.create=function(t,e,n){return e.name=e.name||t,y.Components[t]=this.extend(e,n)};var z=function(t){var e=arguments.length;if(2>e||null==t)return t;for(var n=1;e>n;n++){var i=arguments[n];for(var o in i)t[o]=i[o]}return t},B=function(t,e){var n,o=this;t=t||{},e=e||{},n=Object.keys(t).indexOf("constructor")>=0?t.constructor:function(){return o.apply(this,arguments)},z(n,o,e);var r=function(){this.constructor=n};return r[i]=o[i],n[i]=new r,t&&z(n[i],t),n[i].__super__=o[i],n};M.extend=q.extend=D.extend=B,D.create("Image",{constructor:function(t){var e=this;this[l]=!1,this.opacity=1,this.image=new Image,this.image.onload=function(){t[r]||t[s]||(t[r]=this[r],t[s]=this[s]),e[l]&&e.setTint(e[l]),e.onload&&e.onload(this),t.state.updated=!0},this.image.onerror=function(){e.image=new Image},t.setImage=this.setImage.bind(this)},setTint:function(t){if(this[l]=t,this.image.complete){var e=this[a]=this[a]||n("canvas");e[r]=this.image[r],e[s]=this.image[s];var i=e.getContext("2d");i[h]=this[l],i.fillRect(0,0,e[r],e[s]),i.globalCompositeOperation="destination-atop",i[m]=.75,i[g](this.image,0,0),i[m]=1}return this},setImage:function(t){return this.image.src=t,this},render:function(t){var e=t[m],n=arguments;t[m]=this[p],n[0]=this.image,t[g].apply(t,n),this[l]&&(n[0]=this[a],t[g].apply(t,n)),t[m]=e}}),D.create("Box",{constructor:function(){this[h]="white"},render:function(t,e,n,i,o){t[h]=this[h],t.fillRect(e,n,i,o)}}),D.create("Text",{constructor:function(){this[a]=n("canvas"),this[c]=this[a].getContext("2d");var t=this[d]={};t[f]="32px Arial",t[d]="",t[h]="white",this[p]=1},set:function(t){var e=this[d],n=this.entity,i=this[c],o=this[a];e[f]=t.font||e[f],e[d]=t.text||e[d],e[h]=t.fillStyle||e[h],i[f]=e[f],i[h]=e[h];var u=i.measureText(e[d]);n[r]=o[r]=Math.ceil(u[r]),n[s]=o[s]=Math.ceil(5*parseInt(e[f])/3),i.textBaseline="top",i[f]=e[f],i[h]=e[h],i.fillText(e[d],0,0)},render:function(t){var e=(this[d],this.entity,t[m]);t[m]=this[p],arguments[0]=this[a],t[g].apply(t,arguments),t[m]=e}})}(window,document);