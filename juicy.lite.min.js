"use strict";!function(t,e){var n=function(){return e.createElement("canvas")},i=function(){},o="prototype",r="listener",s="width",a="height",c="canvas",u="context",h="_hR",d="fillStyle",f="font",p="text",m="opacity",l="globalAlpha",g="_tint",v="drawImage",y=function(){return t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||function(e){t.setTimeout(e,1e3/60)}}(),x=t.Juicy={},C=x.Game={},_={x:1,y:1},w={x:0,y:0},k=!1,I=!1,T=!1,R=!1,b=!1,A={},E={},M={},r={};e.onkeydown=function(t){A[t.keyCode]=!0},e.onkeyup=function(t){A[t.keyCode]=!1;var e="key_"+M[t.keyCode];I&&I[e]&&I[e](M[t.keyCode])},C.init=function(t,e,n,i){k=!1,C[s]=e,C[a]=n,C.setCanvas(t),E=i,M={};for(var o in i)M[i[o]]=o},C.keyDown=function(t){if("string"==typeof t)return A[E[t]];for(var e=0;e<t.length;e++)if(C.keyDown(t[e]))return!0;return!1},C.on=function(t,n,i){if("key"===t){"object"!=typeof n&&(n=[n]);for(var o=0;o<n.length;o++){var s=n[o];I["key_"+s]=i}}else r[t]&&e.removeEventListener(t,r[t]),e.addEventListener(t,r[t]=n)},C.clear=function(){for(var t in r)e.removeEventListener(t,r[t]);r={}},C.getCanvasCoords=function(t){var e=T.getBoundingClientRect(),n=t.clientX-e.left,i=t.clientY-e.top;return{x:Math.floor(n*C[s]/T[s]),y:Math.floor(i*C[a]/T[a])}},C.setCanvas=function(t){T=t,R=t.getContext("2d");var e=!1;t.onmousedown=function(t){e=t,C.trigger("dragstart",t)},t.onmouseup=function(t){var n=C.getCanvasCoords(e),i=C.getCanvasCoords(t),o=n.x-i.x,r=n.y-i.y,s=Math.sqrt(o*o+r*r);2>=s?C.trigger("click",t):C.trigger("dragend",t),e=!1},t.onmousemove=function(t){var n=C.getCanvasCoords(t);w.x=n.x,w.y=n.y,e&&C.trigger("drag",t)},C.resize()},C.resize=function(){var t=T.parentElement,e=t[s]||t.clientWidth,n=t[a]||t.clientHeight;T[s]=e,T[a]=e*C[a]/C[s],T[a]>n&&(T[a]=n,T[s]=n*C[s]/C[a]),_={x:T[s]/C[s],y:T[a]/C[a]},I&&(I[h]=!1)},C.setState=function(t){C.clear(),I=t,I.game=C,I.init(),I[h]=!1},C.trigger=function(t,e){e=C.getCanvasCoords(e),I&&I[t]&&I[t](e.x,e.y)},C.update=function(){if(k){y(C.update);var t=(new Date).getTime(),e=(t-b)/1e3;if(e>.2)return void(b=t);try{var n=!I.update(e,C)||I.updated;I.updated=!1,b=t,(n||!I[h])&&(C.render(),I[h]=!0)}catch(i){console.error(i),C.pause()}}},C.render=function(){R.save(),R.scale(_.x,_.y),I.stopClear||R.clearRect(0,0,C[s],C[a]),I.render(R),R.restore()},C.run=function(){k=!0,b=(new Date).getTime(),C.update()},C.pause=function(){k=!1};var S=x.State=function(){};S[o].init=i,S[o].update=i,S[o].render=i;var q=0,D=x.Entity=function(t,e){this.components={},this.updated={},this.state=t,this.children=[],e=e||this.__proto__.components,this.position={x:0,y:0},this.scale={x:1,y:1},this[s]=this[a]=0;for(var n=0;n<e.length;n++)this.addComponent(e[n]);this.init&&this.init()};D[o].components=[],D[o].addComponent=function(t,e){if("function"==typeof t)t=new t(this);else if("string"==typeof t){if(!x.Components[t])throw"Component "+t+" does not exist";t=new x.Components[t](this)}t.__proto__.name||(t.__proto__.name="_component_"+q.toString(),q++);var e=e||t.__proto__.name;if(this.components[e])throw"Component "+e+" already exists";t.entity=this,this.components[e]=t},D[o].getComponent=function(t){return this.components[t]},D[o].update=function(t,e){if(e&&!this.updated[e])return this.updated[e]=!0,this.components[e].update(t,this.state.game),this.components[e];this.updated={};for(var n in this.components)this.updated[n]||this.update(t,n)},D[o].render=function(t){t.save();var e=this.position;t.translate(e.x,e.y),t.scale(this.scale.x,this.scale.y);var n=Array[o].slice.call(arguments);1===n.length&&(n.push(0),n.push(0),n.push(this[s]),n.push(this[a]));for(var i in this.components)this.components[i].render.apply(this.components[i],n);if(this.children.length>0)for(var r=0;r<this.children.length;r++)this.children[r].render(t);t.restore()},D[o].addChild=function(t){t.parent=this,this.children.push(t)};var z=x.Component=function(){};z[o].name=null,z[o].update=i,z[o].render=i,x.Components={},z.create=function(t,e,n){return e.name=e.name||t,x.Components[t]=this.extend(e,n)};var B=function(t){var e=arguments.length;if(2>e||null==t)return t;for(var n=1;e>n;n++){var i=arguments[n];for(var o in i)t[o]=i[o]}return t},F=function(t,e){var n,i=this;t=t||{},e=e||{},n=Object.keys(t).indexOf("constructor")>=0?t.constructor:function(){return i.apply(this,arguments)},B(n,i,e);var r=function(){this.constructor=n};return r[o]=i[o],n[o]=new r,t&&B(n[o],t),n[o].__super__=i[o],n};S.extend=D.extend=z.extend=F,z.create("Image",{constructor:function(t){var e=this;this[g]=!1,this.opacity=1,this.image=new Image,this.image.onload=function(){t[s]||t[a]||(t[s]=this[s],t[a]=this[a]),e[g]&&e.setTint(e[g]),e.onload&&e.onload(this),t.state.updated=!0},this.image.onerror=function(){e.image=new Image},t.setImage=this.setImage.bind(this)},setTint:function(t){if(this[g]=t,this.image.complete){var e=this[c]=this[c]||n("canvas");e[s]=this.image[s],e[a]=this.image[a];var i=e.getContext("2d");i[d]=this[g],i.fillRect(0,0,e[s],e[a]),i.globalCompositeOperation="destination-atop",i[l]=.75,i[v](this.image,0,0),i[l]=1}return this},setImage:function(t){return this.image.src=t,this},render:function(t){var e=t[l],n=arguments;t[l]=this[m],n[0]=this.image,t[v].apply(t,n),this[g]&&(n[0]=this[c],t[v].apply(t,n)),t[l]=e}}),z.create("Box",{constructor:function(){this[d]="white"},render:function(t,e,n,i,o){t[d]=this[d],t.fillRect(e,n,i,o)}}),z.create("Text",{constructor:function(){this[c]=n("canvas"),this[u]=this[c].getContext("2d");var t=this[p]={};t[f]="32px Arial",t[p]="",t[d]="white",this[m]=1},set:function(t){var e=this[p],n=this.entity,i=this[u],o=this[c];e[f]=t.font||e[f],e[p]=t.text||e[p],e[d]=t.fillStyle||e[d],i[f]=e[f],i[d]=e[d];var r=i.measureText(e[p]);n[s]=o[s]=Math.ceil(r[s]),n[a]=o[a]=Math.ceil(5*parseInt(e[f])/3),i.textBaseline="top",i[f]=e[f],i[d]=e[d],i.fillText(e[p],0,0)},render:function(t){var e=t[l];t[l]=this[m],arguments[0]=this[c],t[v].apply(t,arguments),t[l]=e}})}(window,document);
